<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>promise</title>
	<link rel="stylesheet" href="../css/normalize.css">
	<link rel="stylesheet" href="../css/styles/default.css">
	<link rel="stylesheet" href="../css/sidebar.css">
	<script src="../js/jquery-3.2.1-compressed.js"></script>
	<script src="../js/highlight.pack.js"></script>
	<script src="../js/sidebar.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
	<aside id="sidebar">
		<section id="catalog">
			<img id="hideCatalog" src="../images/catalog.png" alt="加载失败">
			目录
		</section>
	</aside>
	<div id="showCatalog">
		<img src="../images/arrow.png">
	</div>
	<article id="container">
		<hgroup>
			<h1 id="title">Promise</h1>
		</hgroup>
		<section>
			<h2>定义</h2>
			<p>
				Promise 是 ES6 新增的构造函数，用于更方便地实现异步编程。
				<pre><code class="javascript">
		// 创建一个 Promise 实例，传入执行函数
		// 执行函数的参数为 resolve 函数和 reject 函数
		var 实例 = new Promise(function(resolve, reject) {
			... // 一堆代码
			if (...) { // 如果达到某个条件，就执行 resolve 函数
				resolve(value);
			}
			if (...) { // 如果达到某个条件，就执行 reject 函数
				reject(value);
			}
		});

		// 执行异步任务，reject 函数是可选的
		// 设置 resolve 函数和 reject 函数的执行内容
		实例对象.then(function(value){
			// resolve 函数
		}, function(value){
			// reject 函数
		});
				</code></pre>
			</p>
		</section>
		<section>
			<h2>使用</h2>
			<p>
				<h3>概念</h3>
				promise 的实例对象有三种状态：<span class="definition"> pending、fulfilled、rejected </span>。
				<ul>
					<li>pending：执行中状态，new Promise 后执行一堆代码的整个过程</li>
					<li>fulfilled：完成状态，执行了 reslove 函数</li>
					<li>rejected：出错状态，执行了 reject 函数或执行一堆代码时出错</li>
					<li>fulfill：将 pending 状态变成 fulfilled 状态（settled）</li>
					<li>reject：将 pending 状态变成 rejected 状态（settled）</li>
				</ul>
				<figure>
					<img src="../images/promise_life.png">
				</figure>
				<h3>执行过程</h3>
				<pre><code class="javascript">
		var promise = new Promise(function(resolve, reject) {
			resolve('执行 resolve 里的代码');
			reject('执行 reject 里的代码');
			console.log('执行 new Promise 里的代码');
		});
		promise.then(function(value) {
			console.log(value);
		}, function(value) {
			console.log(value);
		});
		console.log('执行 window 里的代码');
				</code></pre>
				<figure>
					<img src="../images/promise_demo1.jpg">
				</figure>
				其上例子执行过程为：
				<ol>
					<li>创建 promise 实例，传入执行函数（executor）</li>
					<li>执行 executor 里的代码，控制台输出<span class="definition"> 执行 new Promise 里的代码 </span></li>
					<li>执行 executor 过程中先执行 reslove 函数，所以异步调用 resolve 函数，传入形参<span class="definition"> 执行 resolve 里的代码 </span></li>
					<li>执行 promise.then 对 resolve 函数和 reject 函数的内容进行设置</li>
					<li>控制台输出<span class="definition"> 执行 window 里的代码 </span></li>
					<li>异步执行（终于） resolve 函数，控制台输出<span class="definition"> 执行 resolve 里的代码 </span></li>
				</ol>
				<h3>链式调用</h3>
				promise.then 返回 promise 对象，所以可以进行链式调用。
				<pre><code class="javascript">
		var promise = new Promise(function(resolve, reject) {
			resolve('hello promise');
		});
		promise.then(function(value) {
			console.log(value);
		}).then(function(value) {
			console.log(value);
		});
				</code></pre>
				<figure>
					<img src="../images/promise_demo2.jpg">
				</figure>
				可以看到，第二个 then 执行的 resolve 输出了 undefined ，这是因为以上代码等价于
				<pre><code class="javascript">
		var promise = new Promise(function(resolve, reject) {
			resolve('hello promise');
		});
		promise.then(function(value) {
			console.log(value);
			<div class="strong">
		return new Promise(function(resolve, reject) {
			resolve();
		});
			</div>
		}).then(function(value) {
			console.log(value);
		});
				</code></pre>
				其 resolve 函数自动返回了个 promise 对象，正确的值传递应该是
				<pre><code class="javascript">
		var promise = new Promise(function(resolve, reject) {
			resolve('hello promise');
		});
		promise.then(function(value) {
			console.log(value);
		return new Promise(function(resolve, reject) {
			resolve(<span class="strong">value</span>);
		});
		}).then(function(value) {
			console.log(value);
		});
				</code></pre>
				<figure>
					<img src="../images/promise_demo3.jpg">
				</figure>
			</p>
		</section>
		<section class="refer">
			<h2>参考文献</h2>
			<p>
				<div>[1] MDN Promise <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise</a></div>
			</p>
		</section>
	</article>
</body>
</html>